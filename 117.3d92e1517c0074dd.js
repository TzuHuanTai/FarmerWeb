"use strict";(self.webpackChunkproject=self.webpackChunkproject||[]).push([[117],{2117:(X,P,s)=>{s.r(P),s.d(P,{liveModule:()=>V});var p=s(4006),I=s(7777),u=s(1135),e=s(4650);let f=(()=>{class n{constructor(){this.isConnectedSubject=new u.X(!1),this.connectRTCPeerSubject=new u.X(!1),this.rtcPeerStatusSubject=new u.X("new"),this.recordingSubject=new u.X(!1),this.isConnectedSubject$=this.isConnectedSubject.asObservable(),this.connectRTCPeerSubject$=this.connectRTCPeerSubject.asObservable(),this.rtcPeerStatusSubject$=this.rtcPeerStatusSubject.asObservable(),this.recordingSubject$=this.recordingSubject.asObservable()}isConnected(t){this.isConnectedSubject.next(t)}connectRTCPeer(t){this.connectRTCPeerSubject.next(t)}setRTCStatus(t){this.rtcPeerStatusSubject.next(t)}recordVideo(t){this.recordingSubject.next(t)}}return n.\u0275fac=function(t){return new(t||n)},n.\u0275prov=e.Yz7({token:n,factory:n.\u0275fac}),n})();var w=s(9299),T=s(529),h=s(2340);let y=(()=>{class n{constructor(t){this.http=t,this.headers=new T.WM({"Content-Type":"application/json; charset=UTF-8"})}putGpio(t,i){return this.http.put(`${h.N.raspGpioUrl}/${t.toString()}`,{onoff:i},{headers:this.headers})}getGpioStatus(t){return this.http.get(`${h.N.raspGpioUrl}/${t.toString()}/status`)}getAllGpioStatus(){return this.http.get(`${h.N.raspGpioUrl}/status`)}putPwm(t,i,r){return this.http.put(`${h.N.raspPwmUrl}/${t}`,{freq:i,duty:3e3*r},{headers:this.headers})}}return n.\u0275fac=function(t){return new(t||n)(e.LFG(T.eN))},n.\u0275prov=e.Yz7({token:n,factory:n.\u0275fac}),n})();var a=(()=>{return(n=a||(a={})).AnswerSDP="AnswerSDP",n.AnswerICE="AnswerICE",n.OfferSDP="OfferSDP",n.OfferICE="OfferICE",a;var n})(),d=(()=>{return(n=d||(d={})).H264="H264",n.VP8="VP8",n.VP9="VP9",n.AV1="AV1",d;var n})();function A(n,o){const t=i=>{const r=new RegExp("(a=rtpmap:(\\d*) "+o+"/90000\\r\\n)"),c=i.match(r);if(null==c||c.length<=2)return i;const g=c[2];let l=i.replace(r,"");const H=new RegExp("(a=rtcp-fb:"+g+".*\r\n)","g");l=l.replace(H,"");const x=new RegExp("(a=fmtp:"+g+".*\r\n)","g");l=l.replace(x,"");const M=new RegExp("(a=fmtp:(\\d*) apt="+g+"\\r\\n)"),C=l.match(M);let v="";if(null!=C&&C.length>=3){v=C[2],l=l.replace(M,"");const _=new RegExp("(a=rtpmap:"+v+".*\r\n)","g");l=l.replace(_,"")}let k=/(m=video.*\r\n)/;const m=l.match(k);if(null!=m){const j=m[0].substring(0,m[0].length-2).split(" ");let b=j[0];j.forEach((S,z)=>{0!==z&&(S==g||S==v||(b+=" "+S))}),b+="\r\n",l=l.replace(k,b)}return t(l)};return t(n)}RTCPeerConnection.prototype.setSignalingUrl=function(n){return this.signalingServer=n,this},RTCPeerConnection.prototype.setCodec=function(n){return this.codec=n,this},RTCPeerConnection.prototype.answerDescription=function(n){this.setLocalDescription(n),console.log(a.AnswerSDP,n),this.signalingServer.invoke(a.AnswerSDP,this.connectionId,n).catch(o=>console.error(o.toString()))},RTCPeerConnection.prototype.answerLocalIceToRemote=function(n){n&&this.signalingServer.invoke(a.AnswerICE,this.connectionId,n).catch(o=>console.error(o.toString()))},RTCPeerConnection.prototype.offerDescription=function(n){this.setLocalDescription(n),console.log(a.OfferSDP,n),this.signalingServer.invoke(a.OfferSDP,n).catch(o=>console.error(o.toString()))},RTCPeerConnection.prototype.offerLocalIceToRemote=function(n){n&&this.signalingServer.invoke(a.OfferICE,n).catch(o=>console.error(o.toString()))},RTCPeerConnection.prototype.listenAnswerTopics=function(){this.signalingServer.on(a.AnswerSDP,n=>{console.log("setRemoteDescription: ",n),this.setRemoteDescription(n)}),this.signalingServer.on(a.AnswerICE,n=>{this.addIceCandidate(n).then(()=>{console.log("Add remote ICE candidate: ",n)},o=>{console.log(`Failed to add Ice Candidate: ${o.toString()}`)})})},RTCPeerConnection.prototype.listenOfferTopics=function(){this.signalingServer.on("OfferSDP",n=>{this.setRemoteDescription(n),this.createAnswer().then(o=>{this.answerDescription(o)})}),this.signalingServer.on("OfferICE",n=>{this.addIceCandidate(n).then(()=>{console.log("Add remote ICE candidate: ",n)},o=>{console.log(`Failed to add Ice Candidate: ${o.toString()}`)})})},RTCPeerConnection.prototype.listenTopics=function(n){return this.type=n,"answer"==n?this.listenOfferTopics():"offer"==n&&this.listenAnswerTopics(),this},RTCPeerConnection.prototype.connectServerPeer=function(){this.createOffer().then(n=>{this.codec||(this.codec=d.H264);for(let o in d)o!==this.codec&&(n.sdp=A(n.sdp,o));this.offerDescription(n)})},RTCPeerConnection.prototype.build=function(){return"answer"==this.type?"Connected"!==this.signalingServer.state?this.signalingServer.start().then(()=>{this.signalingServer.invoke("JoinAsServer")}).catch(n=>console.error(n)):this.signalingServer.invoke("JoinAsServer"):"offer"==this.type&&("Connected"!==this.signalingServer.state?this.signalingServer.start().then(()=>{this.signalingServer.invoke("JoinAsClient"),this.connectServerPeer()}).catch(n=>console.error(n)):(this.signalingServer.invoke("JoinAsClient"),this.connectServerPeer())),this};var O=s(7442),L=s(7579),R=s(2722);const Z=["webrtcVideo"];let E=(()=>{class n{constructor(t){this.liveService=t,this.signalingUrl=h.N.signalingUrl,this.unsubscriber=new L.x,this.signalingServer=(new O.su).withUrl(this.signalingUrl).configureLogging(O.in.Information).withAutomaticReconnect().build()}ngOnInit(){this.liveService.connectRTCPeerSubject$.pipe((0,R.R)(this.unsubscriber)).subscribe(t=>{console.log("==== connectRTCPeer ====",t),t?(this.startRTCPeer(),this.forceInterruptInterval=setInterval(()=>{this.liveService.connectRTCPeer(!1)},2e4)):this.closeRTCPeer()}),this.liveService.recordingSubject$.pipe((0,R.R)(this.unsubscriber)).subscribe(t=>{this.dataChannel?.send(t?"1":"0")})}ngOnDestroy(){this.closeRTCPeer(),this.unsubscriber.next(!0),this.unsubscriber.complete()}startRTCPeer(){if(this.peerConnection&&this.closeRTCPeer(),!this.peerConnection){this.peerConnection=this.createPeerConnection();let t=this.webrtcVideo.nativeElement.play();void 0!==t&&t.then(i=>{}).catch(i=>{})}}closeRTCPeer(){this.dataChannel?.close(),this.peerConnection&&(this.peerConnection.close(),this.liveService.isConnected(!1),this.liveService.setRTCStatus(this.peerConnection.connectionState)),this.peerConnection=null,clearInterval(this.forceInterruptInterval)}createPeerConnection(){const t=new RTCPeerConnection(h.N.peerConnectionConfig);return this.dataChannel=t.createDataChannel("record_cmd_channel"),this.dataChannel.onmessage=i=>this.onReceiveMessage(i),t.onicecandidate=i=>{"answer"==t.type?(console.log("answerLocalIceToRemote",i.candidate),t.answerLocalIceToRemote(i.candidate)):"offer"==t.type&&(console.log("offerLocalIceToRemote",i.candidate),t.offerLocalIceToRemote(i.candidate))},t.onconnectionstatechange=i=>{console.log("onconnectionstatechange: ",i)},t.ontrack=i=>{"track"===i.type&&"video"===i.track.kind&&(this.webrtcVideo.nativeElement.srcObject=new MediaStream([i.track]))},t.onconnectionstatechange=i=>{this.liveService.setRTCStatus(t.connectionState),"connected"===t.connectionState?(clearInterval(this.forceInterruptInterval),this.liveService.isConnected(!0)):"disconnected"===t.connectionState&&this.liveService.isConnected(!1)},t.addTransceiver("video",{direction:"recvonly"}),t.addTransceiver("audio",{direction:"recvonly"}),t.setSignalingUrl(this.signalingServer).listenTopics("offer").setCodec(this.codec).build()}reconnectPeerConnection(){this.reconnectingInterval=setInterval(()=>{console.log("WebRTC reconnect!!!"),this.startRTCPeer()},5e3)}onReceiveMessage(t){console.log(new TextDecoder("utf-8").decode(t.data))}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(f))},n.\u0275cmp=e.Xpm({type:n,selectors:[["video-webrtc"]],viewQuery:function(t,i){if(1&t&&e.Gf(Z,7),2&t){let r;e.iGM(r=e.CRH())&&(i.webrtcVideo=r.first)}},inputs:{codec:"codec",signalingUrl:"signalingUrl"},decls:3,vars:0,consts:[[1,"webrtc-video"],["autoplay",""],["webrtcVideo",""]],template:function(t,i){1&t&&(e.TgZ(0,"div",0),e._UZ(1,"video",1,2),e.qZA())},styles:["video[_ngcontent-%COMP%]{position:relative;max-width:100%;max-height:100%;min-width:100%;min-height:100%}.webrtc-video[_ngcontent-%COMP%]{position:relative;height:100%;width:100%}"]}),n})();var J=s(4859),F=s(7392),U=s(1572),W=s(455),D=s(7314);const G=["panel"];let Q=(()=>{class n{constructor(t,i){this.gpioService=t,this.liveService=i,this.isWebrtcConnected=!1,this.isRecording=!1,this.isFullscreen=!1,this.isWebrtcConnecting=!1,this.isWebrtcButtonEnable=!0,this.selectedCodec=d.H264,this.gpioCheckedObject=new N}ngOnInit(){document.getElementsByClassName("wrapper")[0].style.display="contents",this.initializeAllGpioStatus(),this.subscribeWebrtcIsConnected(),document.onfullscreenchange=()=>{this.isFullscreen=!!document.fullscreenElement}}ngOnDestroy(){document.getElementsByClassName("wrapper")[0].style.display=""}subscribeWebrtcIsConnected(){this.liveService.isConnectedSubject$.subscribe(t=>{this.isWebrtcConnected=t,t?this.isWebrtcConnecting=!0:(this.isRecording=!1,this.isWebrtcConnecting=!1),this.isWebrtcButtonEnable=!0})}switchWebrtc(t){this.isWebrtcButtonEnable=!1,this.liveService.connectRTCPeer(t)}switchCodec(){let t=!1;for(let i in d){if(t)return void(this.selectedCodec=d[i]);i===this.selectedCodec&&(t=!0)}this.selectedCodec=d.H264}recordVideo(t){this.isRecording=t,this.liveService.recordVideo(t)}fullscreen(t){t?this.panel.nativeElement.requestFullscreen&&this.panel.nativeElement.requestFullscreen():document.exitFullscreen(),this.isFullscreen=t}changeIntensityOfLed(t){this.gpioService.putPwm(12,500,t).subscribe(i=>{console.log(i)})}setGpio(t,i){const r=Number(i);this.gpioService.putGpio(t,r).subscribe(c=>{console.log(c)})}initializeAllGpioStatus(){this.gpioService.getAllGpioStatus().subscribe(t=>{t.forEach(i=>{switch(i.pin._gpio){case 20:this.gpioCheckedObject.isCheckedFan=Boolean(i.value),console.log(20,this.gpioCheckedObject.isCheckedFan);break;case 21:this.gpioCheckedObject.isCheckedLed=Boolean(i.value),console.log(21,this.gpioCheckedObject.isCheckedLed)}})})}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(y),e.Y36(f))},n.\u0275cmp=e.Xpm({type:n,selectors:[["app-live"]],viewQuery:function(t,i){if(1&t&&e.Gf(G,7),2&t){let r;e.iGM(r=e.CRH())&&(i.panel=r.first)}},features:[e._Bn([y])],decls:37,vars:18,consts:[[1,"control-panel"],["panel",""],[1,"streaming-video"],[3,"codec"],[1,"control-buttons","fullscreen"],[1,"btn-fullscreen"],["mat-mini-fab","","color","primary",3,"click"],[3,"hidden"],[1,"btn-streaming"],["mat-mini-fab","","color","primary",3,"disabled","click"],[1,"spinner",3,"diameter","hidden"],[1,"btn-codecs"],[1,"btn-recording"],[1,"blink",3,"hidden"],[1,"btn-led"],[3,"ngModel","ngModelChange","change"],[1,"btn-led-intensity"],[1,"example-margin",3,"thumbLabel","tickInterval","vertical","change"],[1,"btn-fan"],[1,"example-margin",3,"ngModel","ngModelChange","change"]],template:function(t,i){1&t&&(e.TgZ(0,"div",0,1)(2,"div",2),e._UZ(3,"video-webrtc",3),e.qZA(),e.TgZ(4,"div",4)(5,"div",5)(6,"button",6),e.NdJ("click",function(){return i.fullscreen(!i.isFullscreen)}),e.TgZ(7,"mat-icon",7),e._uU(8,"fullscreen"),e.qZA(),e.TgZ(9,"mat-icon",7),e._uU(10,"fullscreen_exit"),e.qZA()()(),e.TgZ(11,"div",8)(12,"button",9),e.NdJ("click",function(){return i.switchWebrtc(!i.isWebrtcConnected)}),e.TgZ(13,"mat-icon",7),e._uU(14,"play_arrow"),e.qZA(),e.TgZ(15,"mat-icon",7),e._uU(16,"play_disabled"),e.qZA(),e._UZ(17,"mat-spinner",10),e.qZA()(),e.TgZ(18,"div",11)(19,"button",9),e.NdJ("click",function(){return i.switchCodec()}),e._uU(20),e.qZA()(),e.TgZ(21,"div",12)(22,"button",9),e.NdJ("click",function(){return i.recordVideo(!i.isRecording)}),e.TgZ(23,"mat-icon",7),e._uU(24,"fiber_manual_record"),e.qZA(),e.TgZ(25,"mat-icon",13),e._uU(26,"stop"),e.qZA()()(),e.TgZ(27,"div",14),e._uU(28," LED"),e._UZ(29,"br"),e.TgZ(30,"mat-slide-toggle",15),e.NdJ("ngModelChange",function(c){return i.gpioCheckedObject.isCheckedLed=c})("change",function(c){return i.setGpio(21,c.checked)}),e.qZA()(),e.TgZ(31,"div",16)(32,"mat-slider",17),e.NdJ("change",function(c){return i.changeIntensityOfLed(c.value)}),e.qZA()(),e.TgZ(33,"div",18),e._uU(34," Fan"),e._UZ(35,"br"),e.TgZ(36,"mat-slide-toggle",19),e.NdJ("ngModelChange",function(c){return i.gpioCheckedObject.isCheckedFan=c})("change",function(c){return i.setGpio(20,c.checked)}),e.qZA()()()()),2&t&&(e.xp6(3),e.Q6J("codec",i.selectedCodec),e.xp6(4),e.Q6J("hidden",i.isFullscreen),e.xp6(2),e.Q6J("hidden",!i.isFullscreen),e.xp6(3),e.Q6J("disabled",!i.isWebrtcButtonEnable),e.xp6(1),e.Q6J("hidden",i.isWebrtcConnecting),e.xp6(2),e.Q6J("hidden",!i.isWebrtcConnecting),e.xp6(2),e.Q6J("diameter",20)("hidden",i.isWebrtcButtonEnable),e.xp6(2),e.Q6J("disabled",i.isWebrtcConnecting||!i.isWebrtcButtonEnable),e.xp6(1),e.hij("",i.selectedCodec," "),e.xp6(2),e.Q6J("disabled",!i.isWebrtcConnected),e.xp6(1),e.Q6J("hidden",i.isRecording),e.xp6(2),e.Q6J("hidden",!i.isRecording),e.xp6(5),e.Q6J("ngModel",i.gpioCheckedObject.isCheckedLed),e.xp6(2),e.Q6J("thumbLabel",!0)("tickInterval","auto")("vertical",i.isFullscreen),e.xp6(4),e.Q6J("ngModel",i.gpioCheckedObject.isCheckedFan))},directives:[E,J.lW,F.Hw,U.Ou,W.Rr,p.JJ,p.On,D.pH],styles:[".control-buttons[_ngcontent-%COMP%]{position:relative;display:grid;width:30%;grid-template-columns:10% auto auto auto auto 10%;grid-template-rows:auto auto auto auto auto;justify-content:space-between;align-items:center;vertical-align:baseline}.control-buttons[_ngcontent-%COMP%]   .mat-icon[_ngcontent-%COMP%]{vertical-align:baseline}.main[_ngcontent-%COMP%]{grid-area:1 / 2 / 5 / 6}.btn-fullscreen[_ngcontent-%COMP%]{grid-row:5;grid-column:6}.btn-streaming[_ngcontent-%COMP%]{grid-row:1;grid-column:6}.btn-codecs[_ngcontent-%COMP%]{grid-row:2;grid-column:6}.btn-recording[_ngcontent-%COMP%]{grid-row:3;grid-column:6}.btn-led[_ngcontent-%COMP%]{grid-row:1;grid-column:1}.btn-led-intensity[_ngcontent-%COMP%]{grid-row:2;grid-column:1;justify-self:stretch}.btn-fan[_ngcontent-%COMP%]{grid-row:5;grid-column:1}@media (orientation: portrait){.streaming-video[_ngcontent-%COMP%]{width:100%}div[_ngcontent-%COMP%]:-webkit-full-screen   .fullscreen[_ngcontent-%COMP%]{margin-left:5%}div[_ngcontent-%COMP%]:fullscreen   .fullscreen[_ngcontent-%COMP%]{margin-left:5%}}@media (orientation: landscape){.streaming-video[_ngcontent-%COMP%]{position:relative;height:100%;text-align:center}div[_ngcontent-%COMP%]:-webkit-full-screen   .fullscreen[_ngcontent-%COMP%]{position:absolute;top:0px;width:100%;height:100%;justify-items:center}div[_ngcontent-%COMP%]:fullscreen   .fullscreen[_ngcontent-%COMP%]{position:absolute;top:0px;width:100%;height:100%;justify-items:center}div[_ngcontent-%COMP%]:-webkit-full-screen   .btn-led-intensity[_ngcontent-%COMP%]{grid-row:2 / 4;grid-column:1;justify-self:center}div[_ngcontent-%COMP%]:fullscreen   .btn-led-intensity[_ngcontent-%COMP%]{grid-row:2 / 4;grid-column:1;justify-self:center}}.control-panel[_ngcontent-%COMP%]{position:relative;width:100%;display:inline-block}.spinner[_ngcontent-%COMP%]{position:absolute;top:25%;left:25%}@keyframes blink{0%{opacity:1}to{opacity:0}}.blink[_ngcontent-%COMP%]{color:red;animation:blink 1s linear infinite}"]}),n})();class N{constructor(){this.isCheckedLed=!1,this.isCheckedFan=!1}}const B=[{path:"",component:Q,children:[]}];let $=(()=>{class n{constructor(){}}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[w.Bz.forChild(B)],w.Bz]}),n})(),V=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({providers:[f],imports:[[p.u5,I.m,$]]}),n})()}}]);